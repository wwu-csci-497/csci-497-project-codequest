<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | CodeQuest</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <script src="TemplateData/UnityProgress.js"></script>
    <script src="Build/UnityLoader.js"></script>
    <script src="./webview/blockly/blockly_compressed.js" type="text/javascript"></script>
    <script src="./webview/blockly/blocks_compressed.js" type="text/javascript"></script>
    <script src="./webview/blockly/msg/js/en.js" type="text/javascript"></script>
    <script src="./webview/blockly/javascript_compressed.js" type="text/javascript"></script>
    <script src="./webview/JS-Interpreter-master/acorn_interpreter.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="./webview/css/main.css">
    <script>var unityInstance = UnityLoader.instantiate("unityContainer", "Build/Downloads.json", {onProgress: UnityProgress});</script>
  </head>
  <body class='full-dims flex-row-center'>

    <!-- WebGL Unity Game -->
    <div id="webglContainer" class="webgl-content full-dims max-size">
      <div id="unityContainer" class="full-dims max-size"></div>
    </div>

    <!-- Blockly Main Container -->
    <div id="blocklyContainer" class="full-dims flex-col-center max-size">
      <div id="container" class="full-dims flex-row-center">
        <div class="full-dims">

          <!-- Blockly Toolbar and Workspace Area -->
          <div id="blocklyDiv" class="full-dims"></div>
          <xml id="toolbox" style="display: block;"></xml>
          <xml id="workspaceBlocks" style="display: block;"></xml>
        </div>

        <!-- Container for the problem -->
        <div id="viewContainer" class="full-dims flex-col-center">
          <div id="instructions" class="full-dims flex-col-center">
            <iframe id="instructionsFrame" name="instructionsFrame" src=''></iframe>
          </div>
          <div id="generatedCode"></div>
          <div id="toggleGeneratedCode" class="flex-row-center" onclick="toggleCode()"></div>
        </div>
      </div>

      <!-- Cancel and Submit Buttons -->
      <div id="navigation" class="flex-row-center">
        <button id="buttonCancel" onclick="blocklyCancel()">Close</button>
        <button id="buttonSubmit" onclick="blocklySubmit()">Done!</button>
      </div>
    </div>
  </body>
  <script src="./webview/js/codequest_blocks.js" type="text/javascript"></script>
  <script>

    var blockList = null;
    var workspace = null;
    var code = null;
    var codeShow = false;
    var currentProblem = -1;

    // Future function to be used to parse and test Blockly generated code
    function tokenize(code) {
      var tokens = [];
      console.log('tokenizing');
    }

    // Runs the Blockly code in an isolated environment
    function runCode() {
      var myInterpreter = new Interpreter(code);
      myInterpreter.run();
    }

    // Toggles a view to show the JavaScript code
    function toggleCode() {
      codeShow = !codeShow;
      if (codeShow)
        generatedCode.style.display = 'flex';
      else
        generatedCode.style.display = 'none';
    }

    // Generates blockly code into JavaScript
    function generateCode(e) {
      if (e.type == Blockly.Events.MOVE ||
          e.type == Blockly.Events.CHANGE ||
          e.type == Blockly.Events.DELETE) {
        code = Blockly.JavaScript.workspaceToCode(workspace);
        HTML_code = code;
        HTML_code = HTML_code.replace(/\n/g, '<br>');
        generatedCode.innerHTML = HTML_code;
      }
      if (e.type == Blockly.Events.MOVE) {
        console.log('e', e);
        window.frames.instructionsFrame.postMessage('{"function":"showNextInstruction"}', '*');
      }
      console.log('code', code);
    }

    async function getProblemsJSON() {
      fetch("./webview/problems.json")
        .then((response) => {
          return response.json();
        })
        .then((value) => {
          blockList = value;
        });
    }

    // Resizes the container elements when the browser resizes
    function onresize() {
      webglContainer.style.width = document.body.clientWidth - 100 + 'px';
      webglContainer.style.height = document.getElementById('webglContainer').clientWidth / 960 * 600 + 'px';
      unityContainer.style.width = document.body.clientWidth - 100 + 'px';
      unityContainer.style.height = document.getElementById('unityContainer').clientWidth / 960 * 600 + 'px';
      blocklyContainer.style.width = document.getElementById('unityContainer').clientWidth - 160 + 'px';
      blocklyContainer.style.height = document.getElementById('unityContainer').clientHeight - 160 + 'px';
    }
    window.addEventListener('resize', onresize);

    window.onload = function() {
      getProblemsJSON();
      onresize();
    }

    // Reinstates Unity
    function blocklyCancel() {
      showUnity();
      body = {
        'method': 'POST',
        'functionName': 'blocklySubmit',
        'problemId': currentProblem,
        'solved': false
      };
      unityInstance.SendMessage('BlocklyManager', 'BlocklyReturn', JSON.stringify(body)) ;
    }

    // Tests and completes the problem then communicates back to Unity
    function blocklySubmit() {
      //if (testAnswer())
      showUnity();
      body = {
        'method': 'POST',
        'functionName': 'blocklySubmit',
        'problemId': currentProblem,
        'solved': true
      };
      unityInstance.SendMessage('BlocklyManager', 'BlocklyReturn', JSON.stringify(body)) ;
    }

    // Swaps Unity to front
    function showUnity() {
      blocklyContainer.style.zIndex = '-1';
      if (workspace != null) {
        workspace.dispose();
        workspace = null;          
        while (toolbox.children.length > 0)
          toolbox.removeChild(toolbox.children[0]);
        for (var i in categories)
          categories[i]['dom'] = undefined;
      }
    }

    // Swaps Blockly to front
    function showBlockly() {
      blocklyContainer.style.zIndex = '0';
    }

    // Sets and loads the problem ID, then shows Blockly
    function setId(id) {
      currentProblem = id.toString().padStart(4, '0');
      document.getElementById('instructionsFrame').src = './webview/instructions/' + currentProblem + '.html?show=1';
      createBlocks(blockList[currentProblem]);
      setTimeout(showBlockly, 250);
    }

    // Generates the Blockly blocks denoted by the given problemBlock
    function createBlocks(problemBlock) {
      var toolbox = problemBlock['toolbox'];
      var workspc = problemBlock['workspace'];
      var variables = [];
      var functions = [];

      // Attaching blocks except variables and functions to the toolbox
      for (var i = 0 in toolbox) {
        id = createToolboxBlock(toolbox[i]);
        if (id != null) {
          if (id.split('_')[0] == 'createvar')
            variables.push(id);
          if (id.split('_')[0] == 'createfun')
            functions.push(id);
        }
      }

      workspace = Blockly.inject(blocklyDiv, {toolbox: document.getElementById('toolbox')});

      // Attaching variables and functions to the toolbox
      for (var i in variables)
        createToolboxVariable(workspace, variables[i], currentProblem);
      variables = [];
      for (var i in functions)
        createToolboxFunction(workspace, functions[i], currentProblem);
      functions = [];

      // Attaching blocks to the workspace (NOT WORKING)
      // for (var i = 0 in workspc) {
      //   id = createWorkspaceBlock(workspace, workspc[i]);
      //   if (id != null) {
      //     if (id.split('_')[0] == 'createvar')
      //       variables.push(id);
      //     if (id.split('_')[0] == 'createfun')
      //       functions.push(id);
      //   }
      // }
      Blockly.Xml.domToWorkspace(workspaceBlocks, workspace);
      workspace.addChangeListener(generateCode);
    }

    </script>
</html>
