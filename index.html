<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | CodeQuest</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <script src="TemplateData/UnityProgress.js"></script>
    <script src="Build/UnityLoader.js"></script>
    <script src="./webview/blockly/blockly_compressed.js" type="text/javascript"></script>
    <script src="./webview/blockly/blocks_compressed.js" type="text/javascript"></script>
    <script src="./webview/blockly/msg/js/en.js" type="text/javascript"></script>
    <script src="./webview/blockly/javascript_compressed.js" type="text/javascript"></script>
    <script src="./webview/js/codequest_blocks.js" type="text/javascript"></script>
    <script src="./webview/JS-Interpreter-master/acorn_interpreter.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="./webview/css/main.css">
    <script>var unityInstance = UnityLoader.instantiate("unityContainer", "Build/Downloads.json", {onProgress: UnityProgress});</script>
  </head>
  <body class='full-dims flex-row-center'>

    <!-- WebGL Unity Game -->
    <div id="webglContainer" class="webgl-content full-dims max-size" style="position:fixed; overflow:hidden; border-radius:100px;">
      <div id="unityContainer" class="full-dims max-size"></div>
    </div>

    <!-- Blockly Main Container -->
    <div id="blocklyContainer" class="full-dims flex-col-center max-size" style="z-index:-1; position:absolute; overflow:hidden; border-radius:5px; padding:4px; border:10px solid #7C4518;">
      <div id="container" class="full-dims flex-row-center">
        <div class="full-dims">

          <!-- Blockly Toolbar and Workspace Area -->
          <div id="blocklyDiv" class="full-dims" style="position: relative;"></div>
          <xml id="toolbox" style="display: block;"></xml>
          <xml id="workspaceBlocks" style="display: block;">
            <block type="controls_if" id="oui4398uoifjoijdf" x="60" y="38"></block>
          </xml>
        </div>

        <!-- Container for the problem -->
        <div id="viewContainer" class="full-dims flex-col-center">
          <div id="instructions" class="full-dims flex-col-center">
            <iframe id="instructionsFrame" src=''></iframe>
          </div>
          <div id="generated_code" style="display: none; white-space: pre;"></div>
          <div id="toggleGeneratedCode" class="flex-row-center" onclick="toggleCode()"></div>
        </div>
      </div>

      <!-- Cancel and Submit Buttons -->
      <div id="navigation" class="flex-row-center">
        <button id="buttonCancel" onclick="blocklyCancel()">Close</button>
        <button id="buttonSubmit" onclick="blocklySubmit()">Done!</button>
      </div>
    </div>
  </body>
  <script>

    var blockList = null;
    var workspace = null;
    var code = null;
    var codeShow = false;
    var currentProblem = -1;

    // Future function to be used to parse and test Blockly generated code
    function tokenize(code) {
      var tokens = [];
      console.log('tokenizing');
    }

    // Runs the Blockly code in an isolated environment
    function runCode() {
      var myInterpreter = new Interpreter(code);
      myInterpreter.run();
    }

    // Toggles a view to show the JavaScript code
    function toggleCode() {
      codeShow = !codeShow;
      if (codeShow)
        generated_code.style.display = 'flex';
      else
        generated_code.style.display = 'none';
    }

    // Generates blockly code into JavaScript
    function generateCode(e) {
      if (e.type == Blockly.Events.MOVE ||
          e.type == Blockly.Events.CHANGE ||
          e.type == Blockly.Events.DELETE) {
        code = Blockly.JavaScript.workspaceToCode(workspace);
        HTML_code = code;
        HTML_code = HTML_code.replace(/\n/g, '<br>');
        generated_code.innerHTML = HTML_code;
      }
      console.log('code', code);
    }

    async function getProblemsJSON() {
      console.log('getProblemsJSON()')
      fetch("./webview/problems.json")
        .then((response) => {
          blockList = response.json();
        });
    }

    // Resizes the container elements when the browser resizes
    function onresize() {
      document.getElementById('#canvas').width = document.body.clientWidth + 'px';
      document.getElementById('#canvas').height = document.getElementById('#canvas').clientWidth / 960 * 600 + 'px';
      webglContainer.style.width = document.body.clientWidth + 'px';
      webglContainer.style.height = document.getElementById('webglContainer').clientWidth / 960 * 600 + 'px';
      unityContainer.style.width = document.body.clientWidth + 'px';
      unityContainer.style.height = document.getElementById('unityContainer').clientWidth / 960 * 600 + 'px';
      blocklyContainer.style.width = document.getElementById('unityContainer').clientWidth - 160 + 'px';
      blocklyContainer.style.height = document.getElementById('unityContainer').clientHeight - 160 + 'px';
    }
    window.addEventListener('resize', onresize);

    window.onload = function() {
      getProblemsJSON();
      onresize();
    }

    // Reinstates Unity
    function blocklyCancel() {
      showUnity();
      unityInstance.SendMessage('BlocklyManager', 'BlocklyReturn', -1, false);
    }

    // Tests and completes the problem then communicates back to Unity
    function blocklySubmit() {
      //if (testAnswer())
      showUnity();
      unityInstance.SendMessage('BlocklyManager', 'BlocklyReturn', parseInt(currentProblem), true);
    }

    // Swaps Unity to front
    function showUnity() {
      blocklyContainer.style.zIndex = '-1';
      if (workspace != null) {
        workspace.dispose();
        workspace = null;          
        while (toolbox.children.length > 0)
          toolbox.removeChild(toolbox.children[0]);
        for (var i in categories)
          categories[i]['dom'] = undefined;
      }
    }

    // Swaps Blockly to front
    function showBlockly() {
      blocklyContainer.style.zIndex = '0';
    }

    // Sets and loads the problem ID, then shows Blockly
    function setId(id) {
      currentProblem = id.toString().padStart(4, '0');
      instructionsFrame.src = './webview/instructions/' + currentProblem + '.html';
      generateBlocks(blockList[currentProblem]);
      setTimeout(showBlockly, 250);
    }

    // Generates the Blockly blocks denoted by the given problemBlock
    function generateBlocks(problemBlock) {
      var blocks = problemBlock['toolbox'];
      var variables = [];
      var functions = [];
      for (var i = 0 in blocks) {
        id = generateBlock(blocks[i].trim());
        if (id != null) {
          if (id.split('_')[0] == 'createvar')
            variables.push(id);
          if (id.split('_')[0] == 'createfun')
            functions.push(id);
        }
      }
      console.log('variables', variables);
      workspace = Blockly.inject(blocklyDiv, {toolbox: document.getElementById('toolbox')});
      Blockly.Xml.domToWorkspace(workspaceBlocks, workspace);
      workspace.addChangeListener(generateCode);
      for (var i in variables)
        createWorkspaceVariable(workspace, variables[i]);
      for (var i in functions)
        createWorkspaceFunction(workspace, functions[i]);
    }

    </script>
</html>
