<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8">
    <title>CodeQuest Blockly View</title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <script src="./blockly/blockly_compressed.js" type="text/javascript"></script>
    <script src="./blockly/blocks_compressed.js" type="text/javascript"></script>
    <script src="./blockly/msg/js/en.js" type="text/javascript"></script>
    <script src="./blockly/javascript_compressed.js" type="text/javascript"></script>
    <script src="./js/codequest_blocks.js" type="text/javascript"></script>
    <script src="./JS-Interpreter-master/acorn_interpreter.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="./css/main.css">
  </head>
  <body class="flex-col-center">
    <div id="container" class="full-dims flex-row-center">
      <div id="blocklyContainer" class="full-dims">
        <div id="blocklyDiv" class="full-dims" style="position: relative;"></div>
        <xml id="toolbox" style="display: block;">
          <category id='controls' name="Controls" colour="120"></category>
          <category id='logic'  name="Logic" colour="210"></category>
          <category id='math'  name="Math" colour="230"></category>
          <category id='text'  name="Text" colour="160"></category>
          <category id='lists'  name="Lists" colour="260"></category>
          <category id='colour'  name="Color" colour="20"></category>
          <sep></sep>
          <category id='variables'  name="Variables" colour="330" custom="VARIABLE"></category>
          <category id='functions'  name="Functions" colour="290" custom="PROCEDURE"></category>
        </xml>
      </div>
      <div id="viewContainer" class="full-dims flex-col-center">
        <div id="instructions" class="full-dims flex-col-center">
          <iframe id="instructionsFrame" src=''></iframe>
        </div>
        <div id="generated_code" style="display: none; white-space: pre;"></div>
        <div id="toggleGeneratedCode" class="flex-row-center" onclick="toggleCode()"></div>
      </div>
    </div>
    <div id="navigation" class="flex-row-center">
      <button id="buttonCancel">Close</button>
      <button id="buttonSubmit" onclick="runCode()">Done!</button>
    </div>
  </body>
  <script>

    var blockList = null;
    var workspace = null;
    var code = null;
    var codeShow = false;
    var urlVars = getUrlVars();

    function tokenize(code) {
      var tokens = [];
      console.log('hello');
    }

    function runCode() {
      var myInterpreter = new Interpreter(code);
      myInterpreter.run();
      tokens = tokenize(code);
    }

    function toggleCode() {
      codeShow = !codeShow;
      if (codeShow)
        generated_code.style.display = 'flex';
      else
        generated_code.style.display = 'none';
    }

    function generateCode(e) {
      if (e.type == Blockly.Events.MOVE ||
          e.type == Blockly.Events.CHANGE ||
          e.type == Blockly.Events.DELETE) {
        code = Blockly.JavaScript.workspaceToCode(workspace);
        HTML_code = code;
        HTML_code = HTML_code.replace(/\n/g, '<br>');
        generated_code.innerHTML = HTML_code;
      }
      console.log('code', code);
    }

    function getUrlVars() {
      var vars = {};
      var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
        vars[key] = value;
      });
      return vars;
    }

    async function getBlockList() {
      console.log('getBlockList()', 'GET BlockList');
      $.ajax({
          method: 'GET',
          url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRS-1hHM3kpV1Q4ClJtHzl6YVyTzbuF4TFNcKsEOuJG7CCjhd1nCEnAFhRsXOha63SscRS9z-UqAZaH/pub?gid=317397626&single=true&output=csv",
          crossDomain: true,
          success: function(data) {
            blockList = csvJSON(data);
            localStorage.setItem('blockList', JSON.stringify(blockList));
          },
          error: function(jqXHR, status, err) {
            console.error(jqXHR, status, err);
          },
          complete: function (jqXHR, status) {
            getProblemBlocks();
          }
        });
    }

    async function getProblemBlocks() {
      console.log('getProblemBlocks()', 'GET ProblemBlocks');
      $.ajax({
        method: 'GET',
        url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCWHbvr7hOAmEvWdwX-Yairf3Yf2_oWmpFMwJQKyFaxsSTjlY2KnJvQc_Z0t_qVkpxWvd40OFwrFnt/pub?gid=0&single=true&output=csv",
        crossDomain: true,
        success: function(data) {
          problemBlocks = csvJSON2(data);
          localStorage.setItem('problemBlocks', JSON.stringify(problemBlocks));
        },
        error: function(jqXHR, status, err) {
          console.error(jqXHR, status, err);
        },
        complete: function (jqXHR, status) {
          if (urlVars['v'] != null)
            localStorage.setItem('v', urlVars['v']);
          generateBlocks(problemBlocks.find(item => {
            return item.id == urlVars['id']
          }));
        }
      });
    }

    window.onload = function() {
      if (urlVars['id'] == undefined) {
        console.error('ID not included in the url');
        return;
      }
      instructionsFrame.src = './instructions/' + urlVars['id'] + '.html';

      if (urlVars['v'] == undefined || localStorage.getItem('v') != urlVars['v'])
        getBlockList();
      else {
        if (localStorage.getItem('blockList') == null)
          getBlockList();
        else {
          blockList = JSON.parse(localStorage.getItem('blockList'));
          if (localStorage.getItem('problemBlocks') == null)
            getProblemBlocks();
          else {
            var problemBlocks = JSON.parse(localStorage.getItem('problemBlocks'));
            generateBlocks(problemBlocks.find(item => {
              return item.id == urlVars['id']
            }));
          }
        }
      }
    }
    
  function generateBlocks(problemBlock) {
    console.log(problemBlock);
    var blocks = problemBlock['blocks'];
    for (var i = 0; i < blocks.length; i++)
      generateBlock(blocks[i]);
    workspace = Blockly.inject(blocklyDiv, {toolbox: document.getElementById('toolbox')});
    workspace.addChangeListener(generateCode);
  }

  function csvJSON(csv){
    var lines = csv.split("\n");
    var result = [];
    var headers = lines[0].split(",");
    for (var i = 1; i < lines.length; i++) {
        var obj = {};
        var currentline = lines[i].split(",");
        for (var j = 0; j < headers.length; j++)
          obj[headers[j]] = currentline[j];
        result.push(obj);
    }
    return result;
  }

  function csvJSON2(csv){
    var lines = csv.split("\n");
    var result = [];
    for (var i = 1; i < lines.length; i++){
        var obj = {};
        var currentline = lines[i].split(",");
        obj['id'] = currentline[0];
        obj['blocks'] = [];
        for (var j = 1; j < currentline.length; j++) {
          if (currentline[j] == '')
            break;
          obj['blocks'].push(currentline[j]);
        }
        result.push(obj);
    }
    return result;
  }

  </script>
</html>
